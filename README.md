# Distributed tracing demo in Java

The sample application consists of bunch of services using spring-cloud-sleuth-zipkin for distributed tracing.

The catalog service communicates with: 

1. [Product-service] (https://github.com/nklmish/go-distributed-tracing-demo) : Simulates generating products.
2. Price-service : Simulates price calculation for a given product.
3. Communication-Service : Simulates email sending (demonstrate tracing of async communication)

![dependecy diagram generated by zipkin](https://cloud.githubusercontent.com/assets/13149921/20267272/3429a716-aa7a-11e6-874a-5870adb72e5e.png)

## Dependencies
- JDK-8
- [Docker] (https://docs.docker.com/engine/installation/)
- [Go-distributed-tracing-demo] (https://github.com/nklmish/go-distributed-tracing-demo) - clone and run it locally
- [Open-zipkin] (https://github.com/openzipkin/docker-zipkin) - you can run it by executing
```
docker run -d -p 9411:9411 openzipkin/zipkin
```
- MongoDb : you can run it by executing
```
docker run -p 27017:27017 -d mongo
```
Verify whether everything is up
```
docker ps
```
And you should see something like this
![running docker containers](https://cloud.githubusercontent.com/assets/13149921/20248339/5e770592-a9e2-11e6-8859-bec9cdde2157.png)

## Launch
- Price Service
```
./gradlew price-service:run
```
- Catalog Service
```
./gradlew catalog-service:run
```

## Sample Request
```
curl -v http://localhost:8060/1 | jq .
```
```json
{
  "id": 1,
  "price": "100",
  "products": [
    {
      "name": "Product A-1"
    },
    {
      "name": "Product B-1"
    }
  ]
}
```

## Zipkin-UI

You can visit [localhost:9411] (http://localhost:9411) providing you are running zipkin locally and any service from drop down to view traces. 
![selecting-services](https://cloud.githubusercontent.com/assets/13149921/20267365/ae60e53a-aa7a-11e6-93ad-b68f3d15c136.png)
You can use ab to generate some tracing data
```
ab -c 10 -n 10 http://localhost:8060/1
```
![Zipkin-ui](https://cloud.githubusercontent.com/assets/13149921/20267564/97fa8ee4-aa7b-11e6-95d2-bac58f61c022.png)

Click a particular trace to find out more about that trace
![Zipkin-ui](https://cloud.githubusercontent.com/assets/13149921/20267503/5e093cc6-aa7b-11e6-94b6-3e17993e97b7.png)

Click a particular span to view more details 
![Detail view] (https://cloud.githubusercontent.com/assets/13149921/20267329/79bf382c-aa7a-11e6-9f8c-6abd5020ac75.png)

## Custom log events
The application also demonstrates how we can annotate spans with some events. E.g. gc.full, product.fetch, cache.miss, etc are all events that can help
us during debugging an error.
![annotation](https://cloud.githubusercontent.com/assets/13149921/20269887/4cfc1570-aa85-11e6-9926-cdc185d78f44.png)

You can use this information to perform annotation query
![annotation query](https://cloud.githubusercontent.com/assets/13149921/20270285/c85caef4-aa86-11e6-95cc-4cf290f5b6c8.png)

## Error
For ids >= 3 digits, application generates traces with error E.g.
```
curl -v http://localhost:8060/1000 | jq .
```

![error](https://cloud.githubusercontent.com/assets/13149921/20267756/7ab6e84a-aa7c-11e6-926a-f7b05cf654e5.png)
You can click to find out more about error
![error-detail-view](https://cloud.githubusercontent.com/assets/13149921/20267767/888a82e2-aa7c-11e6-9240-76baa45428df.png)

